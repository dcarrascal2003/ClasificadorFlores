<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clasificador de Flores üå∏</title>
    <link rel="icon" href="data:,">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      #resultado {
        font-weight: bold;
        font-size: 2rem;
        text-align: center;
        margin-top: 10px;
      }
      .canvas-container {
        margin: 0 auto;
        border: 1px solid #ccc;
      }
      video {
        display: none;
      }
    </style>
  </head>

  <body>
    <main>
      <div class="px-4 py-2 my-2 text-center border-bottom">
        <h1 class="display-5 fw-bold">Clasificador de Flores üå∏</h1>
        <p class="lead mb-4">Reconoce tipos de flores en tiempo real usando TensorFlow.js</p>
      </div>

      <div class="container mt-4 text-center">
        <video id="video" playsinline autoplay></video>
        <button class="btn btn-primary mb-3" id="cambiar-camara" onclick="cambiarCamara();">Cambiar c√°mara</button>
        <canvas id="canvas" width="400" height="400" style="max-width: 100%;"></canvas>
        <canvas id="othercanvas" width="128" height="128" style="display:none"></canvas>
        <div id="resultado">Esperando modelo...</div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

    <script>
      // === VARIABLES GLOBALES ===
      const canvas = document.getElementById("canvas");
      const video = document.getElementById("video");
      const ctx = canvas.getContext("2d");
      const resultado = document.getElementById("resultado");
      let modelo = null;
      let size = 400;
      let currentStream = null;
      let facingMode = "environment"; // para usar c√°mara trasera del celular

      // === CARGAR MODELO ===
      (async () => {
        try {
          resultado.innerText = "Cargando modelo...";
          modelo = await tf.loadLayersModel("carpeta_salida/model.json");
          resultado.innerText = "Modelo cargado ‚úÖ";
          mostrarCamara();
        } catch (error) {
          resultado.innerText = "‚ùå Error cargando el modelo";
          console.error(error);
        }
      })();

      // === MOSTRAR C√ÅMARA ===
      async function mostrarCamara() {
        const opciones = { video: { facingMode, width: size, height: size }, audio: false };

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          try {
            currentStream = await navigator.mediaDevices.getUserMedia(opciones);
            video.srcObject = currentStream;
            procesarCamara();
            predecir();
          } catch (err) {
            alert("No se pudo acceder a la c√°mara: " + err);
          }
        } else {
          alert("Tu navegador no soporta la c√°mara üò¢");
        }
      }

      // === CAMBIAR ENTRE C√ÅMARAS ===
      function cambiarCamara() {
        if (currentStream) currentStream.getTracks().forEach(track => track.stop());
        facingMode = facingMode === "user" ? "environment" : "user";
        mostrarCamara();
      }

      // === PROCESAR LA C√ÅMARA EN EL CANVAS ===
      function procesarCamara() {
        ctx.drawImage(video, 0, 0, size, size);
        setTimeout(procesarCamara, 30);
      }

      // === PREDICCI√ìN ===
      function predecir() {
        if (modelo != null) {
          const othercanvas = document.getElementById("othercanvas");
          const ctx2 = othercanvas.getContext("2d");

          // Redimensionar a 128x128
          ctx2.drawImage(canvas, 0, 0, 128, 128);

          const imgData = ctx2.getImageData(0, 0, 128, 128);
          let arr = [];
          let fila = [];
          for (let p = 0; p < imgData.data.length; p += 4) {
            const r = imgData.data[p] / 255;
            const g = imgData.data[p + 1] / 255;
            const b = imgData.data[p + 2] / 255;
            fila.push([r, g, b]);
            if (fila.length === 128) {
              arr.push(fila);
              fila = [];
            }
          }
          arr = [arr];
          const tensor = tf.tensor4d(arr);
          const pred = modelo.predict(tensor).dataSync();
          const clase = pred.indexOf(Math.max(...pred));

          const nombres = ["Clavel", "Rosa", "Girasol", "Diente de le√≥n", "Margarita"];
          resultado.innerText = `üåº ${nombres[clase] || "Desconocida"}`;
        }
        setTimeout(predecir, 500);
      }
    </script>
  </body>
</html>
